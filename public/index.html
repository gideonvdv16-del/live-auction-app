<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Auction</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; background: #0f172a; color: #e5e7eb; }
    header { padding: 16px 20px; background: #111827; display: flex; align-items: center; gap: 12px; }
    h1 { margin: 0; font-size: 20px; }
    main { display: grid; grid-template-columns: 1fr 380px; gap: 16px; padding: 16px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 14px; padding: 16px; }
    .item { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 12px; border: 1px solid #1f2937; border-radius: 12px; margin-bottom: 10px; background: #0b1220; }
    .muted { color: #94a3b8; font-size: 12px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input, button, select, textarea {
      background: #0b1220; color: #e5e7eb; border: 1px solid #1f2937; border-radius: 10px; padding: 10px 12px;
    }
    button { cursor: pointer; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .list { max-height: 70vh; overflow: auto; padding-right: 4px; }
    small { color: #94a3b8; }
    .pill { background:#1f2937; padding:4px 8px; border-radius:999px; font-size:12px; }
    .img { width: 90px; height: 70px; object-fit: cover; border-radius: 8px; border: 1px solid #1f2937; }
    .section-title { margin: 8px 0 6px; }
    #adminOnly, #eventArea { display: none; }
  </style>
</head>
<body>
  <header>
    <h1>Live Auction</h1>
    <span class="pill">Multi-Event</span>
    <div class="row" style="margin-left:auto;">
      <label for="displayName"><small>Your name:</small></label>
      <input id="displayName" placeholder="e.g. Gideon" />
      <button id="saveNameBtn">Save</button>
      <button id="projectorBtn" style="display:none;">Projector View</button>
      <button id="exportBtn" style="display:none;">Export CSV</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Items in Event</h2>
      <div id="eventInfo" class="muted">Join an event to begin.</div>
      <div id="items" class="list"></div>
    </section>

    <section class="card">
      <h2>Join / Create Events</h2>
      <div class="row">
        <label><input type="radio" name="role" value="bidder" checked /> Bidder</label>
        <label><input type="radio" name="role" value="admin" /> Admin</label>
      </div>
      <div id="adminPwRow" class="row" style="display:none;">
        <input id="adminPassword" placeholder="Admin password (1234)" />
        <button id="loginAdminBtn">Login as Admin</button>
        <span id="adminLoginMsg" class="muted"></span>
      </div>

      <h3 class="section-title">Available Events</h3>
      <div id="eventsList" class="list" style="max-height: 200px;"></div>
      <div class="grid-2" style="margin-top:8px;">
        <input id="joinEventId" type="number" placeholder="Event ID" />
        <input id="joinEventPw" placeholder="Event password (if protected)" />
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="joinName" placeholder="Your bidder name" />
        <button id="joinBtn">Join Event</button>
        <span id="joinMsg" class="muted"></span>
      </div>

      <div id="adminOnly" style="margin-top:16px;">
        <hr style="border-color:#1f2937;margin:16px 0;" />
        <h3>Create Event (Admin)</h3>
        <input id="newEventName" placeholder="Event name" />
        <div class="row" style="margin-top:8px;">
          <label><input type="checkbox" id="newEventProtected" /> Password protected</label>
          <input id="newEventPassword" placeholder="Event password" />
        </div>
        <div class="row" style="margin-top:8px;">
          <button id="createEventBtn">Create Event</button>
          <span id="createEventMsg" class="muted"></span>
        </div>

        <div id="eventArea" style="margin-top:16px;">
          <hr style="border-color:#1f2937;margin:16px 0;" />
          <h3>Manage Current Event</h3>
          <div class="row">
            <label>Event ID:</label>
            <input id="adminEventId" readonly />
            <span id="adminEventName" class="pill"></span>
          </div>

          <h4 style="margin-top:10px;">Add Item</h4>
          <div class="grid-2" style="margin-top:8px;">
            <input id="newTitle" placeholder="Item title" />
            <input id="newOpeningBid" type="number" min="0" step="1" placeholder="Opening bid (R)" />
          </div>
          <textarea id="newDesc" rows="3" placeholder="Description (optional)" style="margin-top:8px;"></textarea>
          <div class="row" style="margin-top:8px;">
            <input id="photoFile" type="file" accept="image/*" />
            <button id="uploadPhotoBtn">Upload Photo</button>
            <span id="photoMsg" class="muted"></span>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="addItemBtn">Add Item</button>
            <span id="addItemMsg" class="muted"></span>
          </div>

          <h4 class="section-title">Global Min Increment (event)</h4>
          <div class="row">
            <input id="minIncrement" type="number" min="0" step="1" placeholder="Min increment (R)" />
            <button id="saveMinIncBtn">Save</button>
          </div>

          <h4 class="section-title">Item Controls</h4>
          <div class="row">
            <label for="adminItemSelect"><small>Item:</small></label>
            <select id="adminItemSelect"></select>
          </div>
          <div class="row" style="margin-top:8px;">
            <button data-dur="60" id="start60">Start 60s</button>
            <button data-dur="120" id="start120">Start 120s</button>
            <button id="stopTimer">Stop Timer</button>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="markSold">Mark Sold</button>
            <button id="reopen">Reopen</button>
          </div>

          <h4 class="section-title">Projector / Export</h4>
          <div class="row">
            <button id="setCurrentLot">Set Current Lot to Selected</button>
          </div>
        </div>
        <span id="adminMsg" class="muted"></span>
      </div>

      <hr style="border-color:#1f2937;margin:16px 0;" />
      <h3>Bid Panel</h3>
      <div class="row">
        <label for="itemSelect"><small>Item:</small></label>
        <select id="itemSelect"></select>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="bidAmount" type="number" step="1" min="0" placeholder="Enter your bid (R)" />
        <button id="bidBtn">Place Bid</button>
      </div>
      <p id="bidError" style="color:#fca5a5;min-height:20px;"></p>
    </section>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // DOM refs
    const itemsDiv = document.getElementById("items");
    const eventsList = document.getElementById("eventsList");
    const eventInfo = document.getElementById("eventInfo");

    const roleRadios = document.querySelectorAll("input[name='role']");
    const adminPwRow = document.getElementById("adminPwRow");
    const adminPassword = document.getElementById("adminPassword");
    const loginAdminBtn = document.getElementById("loginAdminBtn");
    const adminLoginMsg = document.getElementById("adminLoginMsg");
    const adminOnly = document.getElementById("adminOnly");

    const joinEventId = document.getElementById("joinEventId");
    const joinEventPw = document.getElementById("joinEventPw");
    const joinName = document.getElementById("joinName");
    const joinBtn = document.getElementById("joinBtn");
    const joinMsg = document.getElementById("joinMsg");

    const adminEventId = document.getElementById("adminEventId");
    const adminEventName = document.getElementById("adminEventName");
    const eventArea = document.getElementById("eventArea");

    const displayNameInput = document.getElementById("displayName");
    const saveNameBtn = document.getElementById("saveNameBtn");
    const projectorBtn = document.getElementById("projectorBtn");
    const exportBtn = document.getElementById("exportBtn");

    const newEventName = document.getElementById("newEventName");
    const newEventProtected = document.getElementById("newEventProtected");
    const newEventPassword = document.getElementById("newEventPassword");
    const createEventBtn = document.getElementById("createEventBtn");
    const createEventMsg = document.getElementById("createEventMsg");

    const newTitle = document.getElementById("newTitle");
    const newOpeningBid = document.getElementById("newOpeningBid");
    const newDesc = document.getElementById("newDesc");
    const addItemBtn = document.getElementById("addItemBtn");
    const addItemMsg = document.getElementById("addItemMsg");

    const minIncrement = document.getElementById("minIncrement");
    const saveMinIncBtn = document.getElementById("saveMinIncBtn");
    const adminItemSelect = document.getElementById("adminItemSelect");
    const start60 = document.getElementById("start60");
    const start120 = document.getElementById("start120");
    const stopTimerBtn = document.getElementById("stopTimer");
    const markSoldBtn = document.getElementById("markSold");
    const reopenBtn = document.getElementById("reopen");
    const setCurrentLotBtn = document.getElementById("setCurrentLot");
    const adminMsg = document.getElementById("adminMsg");

    const photoFile = document.getElementById("photoFile");
    const uploadPhotoBtn = document.getElementById("uploadPhotoBtn");
    const photoMsg = document.getElementById("photoMsg");

    const itemSelect = document.getElementById("itemSelect");
    const bidAmount = document.getElementById("bidAmount");
    const bidBtn = document.getElementById("bidBtn");
    const bidError = document.getElementById("bidError");

    // State
    let role = "bidder";
    let currentEvent = null; // {id, name, isProtected, minIncrement, currentLotId}
    let items = [];
    let uploadedImageUrl = null;

    // Role toggling
    roleRadios.forEach(r => r.addEventListener("change", () => {
      role = document.querySelector("input[name='role']:checked").value;
      adminPwRow.style.display = role === "admin" ? "flex" : "none";
      if (role !== "admin") { adminOnly.style.display = "none"; }
    }));

    // Admin login
    loginAdminBtn.addEventListener("click", () => {
      const password = adminPassword.value.trim();
      socket.emit("auth", { role: "admin", password }, (res) => {
        if (!res?.ok) {
          adminLoginMsg.textContent = res?.error || "Login failed";
          return;
        }
        adminOnly.style.display = "block";
        adminLoginMsg.textContent = "Admin logged in ✓";
      });
    });

    // List events on load & when updated
    function renderEventList(list) {
      eventsList.innerHTML = "";
      if (!list?.length) {
        eventsList.innerHTML = `<div class="muted">No events yet.</div>`;
        return;
      }
      list.forEach(e => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <div><strong>${escapeHtml(e.name)}</strong> <span class="pill">ID: ${e.id}</span></div>
            <div class="muted">${e.isProtected ? "Password protected" : "Open to all"} · Items: ${e.itemCount}</div>
          </div>
          <div class="row"><button data-id="${e.id}" class="fillBtn">Fill ID</button></div>
        `;
        eventsList.appendChild(div);
      });
      document.querySelectorAll(".fillBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          joinEventId.value = btn.getAttribute("data-id");
          joinEventId.scrollIntoView({ behavior: "smooth", block: "center" });
        });
      });
    }

    socket.emit("events:list", null, (res) => {
      if (res?.ok) renderEventList(res.events);
    });
    socket.on("eventsUpdated", (payload) => renderEventList(payload.events));

    // Join event as bidder
    joinBtn.addEventListener("click", () => {
      const id = Number(joinEventId.value);
      const pw = joinEventPw.value.trim();
      const nm = (joinName.value || "").trim();
      if (!id) { joinMsg.textContent = "Enter event ID"; return; }
      if (!nm) { joinMsg.textContent = "Enter your bidder name"; return; }
      socket.emit("event:join", { eventId: id, name: nm, password: pw }, (res) => {
        if (!res?.ok) { joinMsg.textContent = res?.error || "Failed to join"; return; }
        currentEvent = res.event;
        items = res.items || [];
        joinMsg.textContent = "Joined ✓ (name locked)";
        eventArea.style.display = (role === "admin") ? "block" : "none";
        adminEventId.value = String(currentEvent.id);
        adminEventName.textContent = currentEvent.name;
        projectorBtn.style.display = "inline-block";
        exportBtn.style.display = "inline-block";
        renderItems();
        updateEventInfo();
      });
    });

    // Create event (admin)
    createEventBtn.addEventListener("click", () => {
      const name = newEventName.value.trim();
      const isProtected = newEventProtected.checked;
      const password = newEventPassword.value.trim();
      socket.emit("admin:createEvent", { name, isProtected, password }, (res) => {
        if (!res?.ok) { createEventMsg.textContent = res?.error || "Failed"; return; }
        createEventMsg.textContent = `Created event #${res.event.id}`;
        // auto-prepare to manage / join
        joinEventId.value = res.event.id;
        joinEventPw.value = isProtected ? password : "";
        adminEventId.value = res.event.id;
        adminEventName.textContent = name;
        eventArea.style.display = "block";
        currentEvent = { id: res.event.id, name, isProtected, minIncrement: 0, currentLotId: null };
        setTimeout(() => createEventMsg.textContent = "", 2000);
      });
    });

    // Projector & Export buttons (depend on currentEvent)
    projectorBtn.addEventListener("click", () => {
      if (!currentEvent?.id) return alert("Join an event first");
      window.open(`/projector.html?eventId=${encodeURIComponent(currentEvent.id)}`, "_blank");
    });
    exportBtn.addEventListener("click", () => {
      if (!currentEvent?.id) return alert("Join an event first");
      window.open(`/export.csv?eventId=${encodeURIComponent(currentEvent.id)}`, "_blank");
    });

    // Name persistence (local, for convenience)
    saveNameBtn.addEventListener("click", () => {
      const name = displayNameInput.value.trim() || "Anonymous";
      localStorage.setItem("auctionDisplayName", name);
      saveNameBtn.textContent = "Saved";
      setTimeout(() => (saveNameBtn.textContent = "Save"), 1200);
    });
    (function initName() {
      const saved = localStorage.getItem("auctionDisplayName");
      if (saved) displayNameInput.value = saved;
    })();

    // ===== Items UI =====
    function renderItems() {
      itemsDiv.innerHTML = "";
      itemSelect.innerHTML = "";
      adminItemSelect.innerHTML = "";

      items.forEach(item => {
        const el = document.createElement("div");
        el.className = "item";
        const timeLeft = item.endTime ? `<span class="timeleft" data-id="${item.id}"></span>` : "";
        const photo = item.imageUrl ? `<img class="img" src="${item.imageUrl}" alt="photo">` : "";

        el.innerHTML = `
          <div>
            <div class="row" style="gap:12px;">${photo}
              <div>
                <div><strong>${escapeHtml(item.title)}</strong> ${currentEvent?.currentLotId === item.id ? '<span class="pill">Current Lot</span>' : ''}</div>
                <div class="muted">${escapeHtml(item.description || "")}</div>
              </div>
            </div>
            <div style="margin-top:6px;">
              <small>
                Status: <strong>${escapeHtml(item.status)}</strong>
                ${item.endTime ? ` | Time left: ${timeLeft}` : ""}
              </small>
            </div>
            <div style="margin-top:6px;">
              <small>Opening: R${num(item.openingBid)} | Current: <strong>R${num(item.currentBid)}</strong> ${item.currentWinner ? `by ${escapeHtml(item.currentWinner)}` : ""}</small>
            </div>
          </div>
          <div class="row">
            <button data-id="${item.id}" class="chooseBtn">Select</button>
          </div>
        `;
        itemsDiv.appendChild(el);

        const opt = document.createElement("option");
        opt.value = item.id;
        opt.textContent = `${item.title} (R${num(item.currentBid)})`;
        itemSelect.appendChild(opt);

        const opt2 = document.createElement("option");
        opt2.value = item.id;
        opt2.textContent = `${item.title} (R${num(item.currentBid)} | ${item.status})`;
        adminItemSelect.appendChild(opt2);
      });

      document.querySelectorAll(".chooseBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          itemSelect.value = btn.getAttribute("data-id");
          itemSelect.scrollIntoView({ behavior: "smooth", block: "center" });
        });
      });

      renderCountdowns();
    }

    function renderCountdowns() {
      const nodes = document.querySelectorAll(".timeleft");
      const now = Date.now();
      nodes.forEach(node => {
        const id = Number(node.getAttribute("data-id"));
        const item = items.find(i => i.id === id);
        if (!item || !item.endTime) return (node.textContent = "");
        const ms = item.endTime - now;
        node.textContent = (ms <= 0) ? "0s" : `${Math.ceil(ms/1000)}s`;
      });
    }
    setInterval(renderCountdowns, 500);

    function updateEventInfo() {
      if (!currentEvent) {
        eventInfo.textContent = "Join an event to begin.";
        return;
      }
      eventInfo.textContent = `Event #${currentEvent.id} — ${currentEvent.name} — Min increment: R${num(currentEvent.minIncrement || 0)}`;
    }

    function num(n) { return Number(n).toFixed(2); }
    function escapeHtml(s) {
      return s?.replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c])) || "";
    }

    // ===== File upload (admin, uses entered admin password as token) =====
    uploadPhotoBtn?.addEventListener("click", async () => {
      if (!photoFile.files[0]) return photoMsg.textContent = "Choose a file first";
      photoMsg.textContent = "Uploading...";
      const fd = new FormData();
      fd.append("photo", photoFile.files[0]);
      fd.append("adminToken", adminPassword.value.trim());
      try {
        const res = await fetch("/api/upload", { method: "POST", body: fd });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "Upload failed");
        uploadedImageUrl = data.url;
        photoMsg.textContent = "Uploaded ✓";
      } catch (e) {
        photoMsg.textContent = "Error: " + e.message;
      }
    });

    // ===== Add item (admin) =====
    addItemBtn?.addEventListener("click", () => {
      if (!currentEvent?.id) return (addItemMsg.textContent = "Join an event first");
      const title = newTitle.value.trim();
      const openingBid = Number(newOpeningBid.value);
      const description = newDesc.value.trim();

      socket.emit("admin:createItem", {
        eventId: currentEvent.id,
        title, description, openingBid,
        imageUrl: uploadedImageUrl
      }, (res) => {
        if (!res?.ok) return (addItemMsg.textContent = res?.error || "Failed");
        newTitle.value = ""; newOpeningBid.value = ""; newDesc.value = "";
        uploadedImageUrl = null; photoFile.value = ""; photoMsg.textContent = "";
        addItemMsg.textContent = "Item added.";
        setTimeout(() => addItemMsg.textContent = "", 1500);
      });
    });

    // ===== Min increment (admin) =====
    saveMinIncBtn?.addEventListener("click", () => {
      if (!currentEvent?.id) return;
      const v = Number(minIncrement.value);
      socket.emit("admin:setMinIncrement", { eventId: currentEvent.id, value: v }, (res) => {
        if (!res?.ok) return adminMsgResult(res?.error || "Failed", true);
        adminMsgResult(`Min increment set to R${Number(res.minIncrement).toFixed(2)}`);
      });
    });

    // ===== Timer & status (admin) =====
    [start60, start120].forEach(btn => btn?.addEventListener("click", () => {
      const dur = Number(btn.getAttribute("data-dur"));
      const itemId = Number(adminItemSelect.value);
      socket.emit("admin:startTimer", { eventId: currentEvent.id, itemId, durationSeconds: dur }, (res) => {
        if (!res?.ok) return adminMsgResult(res?.error || "Failed", true);
        adminMsgResult(`Timer started: ${dur}s`);
      });
    }));
    stopTimerBtn?.addEventListener("click", () => {
      const itemId = Number(adminItemSelect.value);
      socket.emit("admin:stopTimer", { eventId: currentEvent.id, itemId }, (res) => {
        if (!res?.ok) return adminMsgResult(res?.error || "Failed", true);
        adminMsgResult("Timer stopped");
      });
    });
    markSoldBtn?.addEventListener("click", () => {
      const itemId = Number(adminItemSelect.value);
      socket.emit("admin:markSold", { eventId: currentEvent.id, itemId }, (res) => {
        if (!res?.ok) return adminMsgResult(res?.error || "Failed", true);
        adminMsgResult("Item marked SOLD");
      });
    });
    reopenBtn?.addEventListener("click", () => {
      const itemId = Number(adminItemSelect.value);
      socket.emit("admin:reopen", { eventId: currentEvent.id, itemId }, (res) => {
        if (!res?.ok) return adminMsgResult(res?.error || "Failed", true);
        adminMsgResult("Item reopened");
      });
    });
    setCurrentLotBtn?.addEventListener("click", () => {
      const itemId = Number(adminItemSelect.value);
      socket.emit("admin:setCurrentLot", { eventId: currentEvent.id, itemId }, (res) => {
        if (!res?.ok) return adminMsgResult(res?.error || "Failed", true);
        adminMsgResult(`Current lot set to item #${res.currentLotId}`);
      });
    });

    function adminMsgResult(msg, isError=false) {
      adminMsg.textContent = msg;
      adminMsg.style.color = isError ? "#fca5a5" : "#94a3b8";
      setTimeout(() => adminMsg.textContent = "", 2000);
    }

    // ===== Bidding (bidder only; server enforces locked names) =====
    bidBtn.addEventListener("click", () => {
      bidError.textContent = "";
      if (!currentEvent?.id) { bidError.textContent = "Join an event first"; return; }
      const id = Number(itemSelect.value);
      const amount = Number(bidAmount.value);
      const name = (displayNameInput.value || "").trim() || "Anonymous"; // UX only; server checks locked name
      socket.emit("placeBid", { eventId: currentEvent.id, itemId: id, amount, name }, (res) => {
        if (!res?.ok) bidError.textContent = res?.error || "Unknown error";
        else bidAmount.value = "";
      });
    });

    // ===== Socket updates within the joined event =====
    socket.on("items", (serverItems) => { items = serverItems; renderItems(); });
    socket.on("itemUpdated", (item) => {
      const idx = items.findIndex(i => i.id === item.id);
      if (idx >= 0) items[idx] = item; else items.push(item);
      renderItems();
    });
    socket.on("eventConfigUpdated", (cfg) => {
      if (!currentEvent || cfg.eventId !== currentEvent.id) return;
      currentEvent.minIncrement = cfg.minIncrement ?? currentEvent.minIncrement;
      currentEvent.currentLotId = cfg.currentLotId ?? currentEvent.currentLotId;
      updateEventInfo();
      renderItems();
    });

    // Utils
    function escapeHtml(s) {
      return s?.replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c])) || "";
    }
    function num(n) { return Number(n).toFixed(2); }
  </script>
</body>
</html>
